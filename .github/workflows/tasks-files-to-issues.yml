name: Tasks files → Issues (auto)

on:
  push:
    paths:
      - "tasks/**"

permissions:
  contents: read
  issues: write

jobs:
  to_issues:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create issues from new/changed tasks files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const { context, github } = require('@actions/github');

            const files = context.payload.commits.flatMap(c => c.added.concat(c.modified))
              .filter(p => p.startsWith('tasks/'));

            for (const f of files) {
              const body = fs.readFileSync(f, 'utf8');
              // Tytuł = pierwsza linia niepusta bez '#'
              const lines = body.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
              const title = (lines.find(l=>!l.startsWith('#')) || lines[0] || 'Agent task').replace(/^\*\*Task:\*\*\s*/,'').slice(0, 120);
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title || 'Agent task',
                labels: ['agent-task']
              });
            }
