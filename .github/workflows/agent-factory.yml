name: Agent Factory

on:
  issues:
    types: [opened, labeled, edited, reopened]
  workflow_dispatch:
    inputs:
      issue:
        description: "Issue number (manual run)"
        required: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  factory:
    # Działa gdy:
    # - to event 'issues' i issue MA etykietę 'agent-task'
    # - lub odpalone ręcznie (workflow_dispatch)
    if: >
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-task'))
      || (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    env:
      # Numer issue: z eventu 'issues' lub z inputu workflow_dispatch
      ISSUE_NUMBER: ${{ github.event_name == 'issues' && github.event.issue.number || inputs.issue }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Load issue data (title, labels)
        id: load
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            core.setOutput('title', issue.title);
            core.setOutput('labels', issue.labels.map(l => typeof l === 'string' ? l : l.name).join(','));
      - name: Guard: require agent-task label
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Labels: ${{ steps.load.outputs.labels }}"
          echo "${{ steps.load.outputs.labels }}" | grep -qi "\bagent-task\b" || {
            echo "Issue #${ISSUE_NUMBER} nie ma etykiety 'agent-task' – przerwanie.";
            exit 1;
          }

      - name: Derive role from title prefix (safe)
        id: role
        shell: bash
        env:
          TITLE: ${{ steps.load.outputs.title }}
        run: |
          set -euo pipefail
          LOW=$(printf '%s' "$TITLE" | tr '[:upper:]' '[:lower:]')
          ROLE="generic"
          case "$LOW" in
            *"audio coach"*) ROLE="agent-audio" ;;
            *"exercise builder"*) ROLE="agent-ex" ;;
            *"ux guard"*) ROLE="agent-ux" ;;
            *"security"*) ROLE="agent-sec" ;;
            *"content curator"*) ROLE="agent-cur" ;;
          esac
          echo "role=$ROLE" >> "$GITHUB_OUTPUT"

      - name: Create feature branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          BR="feature/auto/issue-${ISSUE_NUMBER}"
          git config user.name "agent-factory-bot"
          git config user.email "agent-factory-bot@users.noreply.github.com"
          # utwórz lub przełącz (jeśli już istnieje po wcześniejszym runie)
          git checkout -B "$BR"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"

      # === SCAFFOLDS ===

      - name: Scaffold (agent-audio)
        if: steps.role.outputs.role == 'agent-audio'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p src/lib/audio src/components
          cat > src/lib/audio/simplePitch.ts <<'TS'
export function estimatePitch(samples: Float32Array, sampleRate: number): number {
  const N = samples.length;
  const w = new Float32Array(N);
  for (let i=0; i<N; i++) w[i] = samples[i] * (0.54 - 0.46 * Math.cos((2*Math.PI*i)/(N-1)));
  const minF=70, maxF=450;
  const minLag = Math.floor(sampleRate/maxF);
  const maxLag = Math.floor(sampleRate/minF);
  let bestLag=0, bestR=0;
  for (let lag=minLag; lag<=Math.min(maxLag, N-1); lag++){
    let r=0; for (let i=0;i<N-lag;i++) r += w[i]*w[i+lag];
    if (r>bestR){bestR=r;bestLag=lag;}
  }
  return bestLag ? sampleRate/bestLag : 0;
}
TS
          cat > src/components/AudioOverlay.tsx <<'TSX'
import React, { useEffect, useRef, useState } from "react";
import { estimatePitch } from "../lib/audio/simplePitch";
export default function AudioOverlay() {
  const canvasRef = useRef<HTMLCanvasElement|null>(null);
  const [hz, setHz] = useState(0);
  useEffect(() => {
    const AC = (window as any).AudioContext || (window as any).webkitAudioContext;
    const ctx = new AC();
    const analyser = ctx.createAnalyser(); analyser.fftSize = 2048;
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
      const src = ctx.createMediaStreamSource(stream); src.connect(analyser);
      const buf = new Float32Array(analyser.fftSize);
      const draw = () => {
        // TS typy WebAudio bywają różne w DOM lib – rzutujemy bezpiecznie:
        (analyser as any).getFloatTimeDomainData(buf as Float32Array);
        const pitch = Math.floor(estimatePitch(buf, ctx.sampleRate));
        setHz(pitch);
        const c = canvasRef.current; if(!c){ requestAnimationFrame(draw); return; }
        const g = c.getContext("2d")!; const mid = c.height/2;
        g.clearRect(0,0,c.width,c.height); g.beginPath();
        for(let i=0;i<buf.length;i++){
          const x = i*c.width/buf.length; const y = mid + buf[i]*mid*0.9;
          i===0? g.moveTo(x,y): g.lineTo(x,y);
        }
        g.strokeStyle = "#0a7"; g.lineWidth = 2; g.stroke();
        requestAnimationFrame(draw);
      };
      requestAnimationFrame(draw);
    });
  }, []);
  return (
    <div className="p-4 rounded-2xl border">
      <div className="mb-2 text-sm opacity-70">Overlay fali + pitch (demo)</div>
      <canvas ref={canvasRef} width={600} height={160} className="w-full border rounded-lg" />
      <div className="mt-2 text-sm">Pitch (Hz): <b>{hz}</b></div>
    </div>
  );
}
TSX

      - name: Scaffold (agent-ex)
        if: steps.role.outputs.role == 'agent-ex'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p public/content/exercises src/components
          if [ ! -f public/content/exercises/index.json ]; then
            cat > public/content/exercises/index.json <<'JSON'
{
  "packs": [
    {
      "id":"vowels-long",
      "title":"Samogłoski długie",
      "description":"Zestaw startowy",
      "file":"/content/exercises/vowels-long.json"
    }
  ]
}
JSON
          fi
          if [ ! -f public/content/exercises/vowels-long.json ]; then
            cat > public/content/exercises/vowels-long.json <<'JSON'
{
  "id":"vowels-long",
  "title":"Samogłoski długie",
  "units":[
    {
      "phoneme":"iː",
      "letter":"ie / i",
      "examples":["bieten","Lied"],
      "hint_articulation":"Usta rozciągnięte, język przód-wysoko."
    }
  ]
}
JSON
          fi

      - name: Commit & push branch
        shell: bash
        env:
          ISSUE_TITLE: ${{ steps.load.outputs.title }}
        run: |
          set -euo pipefail
          git add -A
          git commit -m "feat(agent): scaffold for issue #${ISSUE_NUMBER} — ${ISSUE_TITLE}" || echo "No changes"
          git push --set-upstream origin "${{ steps.branch.outputs.branch }}"

      - name: Open draft PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = "${{ steps.branch.outputs.branch }}";
            const base = "main";
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const title = `[AUTO] ${issue.title}`;
            const body = `Automatyczny szkic PR dla #${issue_number}
- Gałąź: \`${head}\`
- Rola: \`${{ steps.role.outputs.role }}\`

Podgląd znajdziesz w artefaktach CI (dist).`;
            const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body, draft: true });
            await github.rest.issues.createComment({ owner, repo, issue_number, body: `Draft PR otwarty: #${pr.data.number}` });
