name: Agent Factory

on:
  issues:
    types: [opened, labeled, edited, reopened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  factory:
    # działa tylko, gdy issue ma etykietę agent-task
    if: contains(join(github.event.issue.labels.*.name, ','), 'agent-task')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Derive role from title (safe)
        id: role
        shell: bash
        env:
          TITLE: ${{ github.event.issue.title }}
        run: |
          set -euo pipefail
          low="$(printf '%s' "$TITLE" | tr '[:upper:]' '[:lower:]')"
          role="generic"
          case "$low" in
            *"audio coach"*) role="agent-audio" ;;
            *"exercise builder"*) role="agent-ex" ;;
            *"ux guard"*) role="agent-ux" ;;
            *"security"*) role="agent-sec" ;;
            *"content curator"*) role="agent-cur" ;;
          esac
          echo "role=$role" >> "$GITHUB_OUTPUT"

      - name: Create feature branch
        id: branch
        shell: bash
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          br="feature/auto/issue-${ISSUE_NUMBER}"
          git config user.name "agent-factory-bot"
          git config user.email "agent-factory-bot@users.noreply.github.com"
          git checkout -b "$br"
          echo "branch=$br" >> "$GITHUB_OUTPUT"

      - name: Drop role marker file (scaffold stub)
        shell: bash
        env:
          ROLE: ${{ steps.role.outputs.role }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          set -euo pipefail
          mkdir -p agents/scaffold
          cat > "agents/scaffold/${ROLE}-issue-${ISSUE_NUMBER}.md" <<EOF
# Agent scaffold

- Role: ${ROLE}
- Issue: #${ISSUE_NUMBER}
- Title: ${ISSUE_TITLE}

This is an initial marker file created by Agent Factory.
EOF

      - name: Commit & push
        shell: bash
        env:
          BRANCH: ${{ steps.branch.outputs.branch }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          set -euo pipefail
          git add -A
          git commit -m "chore(agent-factory): scaffold for issue #${ISSUE_NUMBER} — ${ISSUE_TITLE}" || echo "No changes"
          git push --set-upstream origin "$BRANCH"

      - name: Open draft PR
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ steps.branch.outputs.branch }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = process.env.BRANCH;
            const base = "main";
            const title = `[AUTO] ${context.payload.issue.title}`;
            const body = `Automatyczny szkic PR dla #${process.env.ISSUE_NUMBER}
- Gałąź: \`${head}\`
- Podstawowy scaffold dodany w \`agents/scaffold\`.`;
            const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body, draft: true });
            await github.rest.issues.createComment({
              owner, repo,
              issue_number: Number(process.env.ISSUE_NUMBER),
              body: `Draft PR otwarty: #${pr.data.number}`
            });
