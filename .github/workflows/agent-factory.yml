name: Agent Factory

on:
  issues:
    types: [opened, labeled, edited, reopened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  factory:
    if: contains(github.event.issue.labels.*.name, 'agent-task')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Derive role from title prefix (safe)
        id: role
        shell: bash
        env:
          TITLE: ${{ github.event.issue.title }}
        run: |
          set -euo pipefail
          LOW=$(printf '%s' "$TITLE" | tr '[:upper:]' '[:lower:]')
          ROLE="generic"
          case "$LOW" in
            *"audio coach"*) ROLE="agent-audio" ;;
            *"exercise builder"*) ROLE="agent-ex" ;;
            *"ux guard"*) ROLE="agent-ux" ;;
            *"security"*) ROLE="agent-sec" ;;
            *"content curator"*) ROLE="agent-cur" ;;
          esac
          echo "role=$ROLE" >> "$GITHUB_OUTPUT"

      - name: Create feature branch
        id: branch
        shell: bash
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          BR="feature/auto/issue-${ISSUE_NUMBER}"
          git config user.name "agent-factory-bot"
          git config user.email "agent-factory-bot@users.noreply.github.com"
          git checkout -b "$BR"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"

      - name: Scaffold (agent-audio)
        if: steps.role.outputs.role == 'agent-audio'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p src/lib/audio src/components
          cat > src/lib/audio/simplePitch.ts <<'TS'
export function estimatePitch(samples: Float32Array, sampleRate: number): number {
  const N = samples.length;
  const w = new Float32Array(N);
  for (let i=0; i<N; i++) w[i] = samples[i] * (0.54 - 0.46 * Math.cos((2*Math.PI*i)/(N-1)));
  const minF=70, maxF=450;
  const minLag = Math.floor(sampleRate/maxF);
  const maxLag = Math.floor(sampleRate/minF);
  let bestLag=0, bestR=0;
  for (let lag=minLag; lag<=Math.min(maxLag, N-1); lag++){
    let r=0; for (let i=0;i<N-lag;i++) r += w[i]*w[i+lag];
    if (r>bestR){bestR=r;bestLag=lag;}
  }
  return bestLag ? sampleRate/bestLag : 0;
}
TS
          cat > src/components/AudioOverlay.tsx <<'TSX'
import React, { useEffect, useRef, useState } from "react";
import { estimatePitch } from "../lib/audio/simplePitch";
export default function AudioOverlay() {
  const canvasRef = useRef<HTMLCanvasElement|null>(null);
  const [hz, setHz] = useState(0);
  useEffect(() => {
    const ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
    const analyser = ctx.createAnalyser(); analyser.fftSize = 2048;
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
      const src = ctx.createMediaStreamSource(stream); src.connect(analyser);
      const buf = new Float32Array(analyser.fftSize);
      const draw = () => {
        analyser.getFloatTimeDomainData(buf as any);
        const pitch = estimatePitch(buf, ctx.sampleRate)|0; setHz(pitch);
        const c = canvasRef.current; if(!c) return requestAnimationFrame(draw);
        const g = c.getContext("2d")!; const mid = c.height/2;
        g.clearRect(0,0,c.width,c.height); g.beginPath();
        for(let i=0;i<buf.length;i++){
          const x = i*c.width/buf.length; const y = mid + buf[i]*mid*0.9;
          i===0? g.moveTo(x,y): g.lineTo(x,y);
        }
        g.strokeStyle = "#0a7"; g.lineWidth = 2; g.stroke();
        requestAnimationFrame(draw);
      };
      requestAnimationFrame(draw);
    });
  }, []);
  return (
    <div className="p-4 rounded-2xl border">
      <div className="mb-2 text-sm opacity-70">Overlay fali + pitch (demo)</div>
      <canvas ref={canvasRef} width={600} height={160} className="w-full border rounded-lg" />
      <div className="mt-2 text-sm">Pitch (Hz): <b>{hz}</b></div>
    </div>
  );
}
TSX

      - name: Scaffold (agent-ex)
        if: steps.role.outputs.role == 'agent-ex'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p public/content/exercises src/components
          if [ ! -f public/content/exercises/index.json ]; then
            cat > public/content/exercises/index.json <<'JSON'
{ "packs": [ { "id":"vowels-long","title":"Samogłoski długie","description":"Zestaw startowy","file":"/content/exercises/vowels-long.json"} ] }
JSON
          fi
          if [ ! -f public/content/exercises/vowels-long.json ]; then
            cat > public/content/exercises/vowels-long.json <<'JSON'
{ "id":"vowels-long","title":"Samogłoski długie","units":[{"phoneme":"iː","letter":"ie/i","examples":["bieten","Lied"],"hint_articulation":"Usta rozciągnięte, język przód-wysoko."}]}
JSON
          fi

      - name: Commit & push branch
        shell: bash
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          set -euo pipefail
          git add -A
          git commit -m "feat(agent): scaffold for issue #${ISSUE_NUMBER} — ${ISSUE_TITLE}" || echo "No changes"
          git push --set-upstream origin "${{ steps.branch.outputs.branch }}"

      - name: Open draft PR
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ROLE: ${{ steps.role.outputs.role }}
          BRANCH: ${{ steps.branch.outputs.branch }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = process.env.BRANCH;
            const base = "main";
            const title = `[AUTO] ${context.payload.issue.title}`;
            const body = `Automatyczny szkic PR dla #${process.env.ISSUE_NUMBER}
- Gałąź: \`${head}\`
- Rola: \`${process.env.ROLE}\`

Podgląd znajdziesz w artefaktach CI (dist).`;
            const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body, draft: true });
            await github.rest.issues.createComment({ owner, repo, issue_number: Number(process.env.ISSUE_NUMBER), body: `Draft PR otwarty: #${pr.data.number}` });
